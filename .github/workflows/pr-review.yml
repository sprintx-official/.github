# =============================================================================
# ORGANIZATION REUSABLE WORKFLOW - AI PR Review
# =============================================================================
# Individual repos can call this workflow with just a few lines:
#
# jobs:
#   review:
#     uses: sprintx-official/.github/.github/workflows/pr-review.yml@main
#     secrets: inherit
# =============================================================================

name: AI PR Review (Reusable)

on:
  workflow_call:
    inputs:
      conventions_path:
        description: 'Path to conventions file'
        required: false
        type: string
        default: '.planning/CONVENTIONS.md'
      project_path:
        description: 'Path to project standards file'
        required: false
        type: string
        default: '.planning/PROJECT.md'
      model:
        description: 'Gemini model to use'
        required: false
        type: string
        default: 'gemini-1.5-pro'
    secrets:
      GEMINI_API_KEY:
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    name: Gemini PR Review

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git diff origin/${{ github.base_ref }}...origin/${{ github.head_ref }} > pr_diff.txt
          git diff --name-only origin/${{ github.base_ref }}...origin/${{ github.head_ref }} > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Read project conventions
        id: conventions
        run: |
          if [ -f "${{ inputs.conventions_path }}" ]; then
            cat "${{ inputs.conventions_path }}" > conventions_content.txt
          else
            echo "No conventions file found at ${{ inputs.conventions_path }}" > conventions_content.txt
          fi

          if [ -f "${{ inputs.project_path }}" ]; then
            cat "${{ inputs.project_path }}" > project_content.txt
          else
            echo "No project file found at ${{ inputs.project_path }}" > project_content.txt
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Gemini PR Review
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GEMINI_MODEL: ${{ inputs.model }}
        run: |
          node << 'NODE_EOF'
          const fs = require('fs');
          const https = require('https');

          const diff = fs.readFileSync('pr_diff.txt', 'utf8').slice(0, 30000);
          const changedFiles = fs.readFileSync('changed_files.txt', 'utf8');
          const conventions = fs.readFileSync('conventions_content.txt', 'utf8');
          const project = fs.readFileSync('project_content.txt', 'utf8');
          const prTitle = process.env.PR_TITLE || 'No title';
          const prBody = process.env.PR_BODY || 'No description';
          const model = process.env.GEMINI_MODEL || 'gemini-1.5-pro';

          const prompt = `You are an expert code reviewer. Review the following PR diff against the project standards and conventions.

          ## Project Standards

          ${project}

          ## Coding Conventions

          ${conventions}

          ## PR Information

          **Title:** ${prTitle}
          **Description:** ${prBody}

          ## Changed Files

          ${changedFiles}

          ## Code Diff

          \`\`\`diff
          ${diff}
          \`\`\`

          ## Review Instructions

          Provide a thorough code review covering:

          ### 1. Convention Compliance
          - File naming conventions
          - Component/function naming conventions
          - Import organization
          - Code style rules from conventions

          ### 2. Code Quality
          - Clean, readable code
          - Proper error handling
          - DRY principles
          - Single responsibility
          - Proper typing (if TypeScript)

          ### 3. Security
          - No hardcoded secrets
          - Input validation
          - XSS prevention
          - Injection prevention

          ### 4. Performance
          - Unnecessary re-renders (React)
          - Heavy computations
          - Missing optimizations
          - Bundle size impact

          ### 5. Best Practices
          - Framework-specific patterns
          - Proper use of hooks/lifecycle
          - Accessibility concerns

          ## Output Format

          ### Summary
          [Brief overall assessment - 1-2 sentences]

          ### Issues Found
          [List each issue with severity]

          ðŸ”´ **Critical** - Must fix before merge
          ðŸŸ  **Warning** - Should fix
          ðŸŸ¡ **Suggestion** - Nice to have

          Format:
          **File:** \`filename\`
          **Line:** X (if applicable)
          **Severity:** [emoji]
          **Issue:** Description
          **Fix:** How to resolve

          ### What's Good
          [Positive feedback on well-written code]

          ### Recommendations
          [General improvements]

          If no issues found, acknowledge the good work!`;

          const requestBody = JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
              temperature: 0.3,
              topK: 40,
              topP: 0.95,
              maxOutputTokens: 8192
            }
          });

          const options = {
            hostname: 'generativelanguage.googleapis.com',
            path: `/v1beta/models/${model}:generateContent?key=${process.env.GEMINI_API_KEY}`,
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(requestBody)
            }
          };

          const req = https.request(options, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
              try {
                const json = JSON.parse(data);
                if (json.candidates?.[0]?.content?.parts?.[0]?.text) {
                  fs.writeFileSync('review_output.txt', json.candidates[0].content.parts[0].text);
                  console.log('Review generated successfully');
                } else if (json.error) {
                  fs.writeFileSync('review_output.txt', `API Error: ${json.error.message}`);
                  console.error('API Error:', json.error.message);
                } else {
                  fs.writeFileSync('review_output.txt', 'Unexpected response format from Gemini API');
                  console.error('Unexpected response:', data);
                }
              } catch (e) {
                fs.writeFileSync('review_output.txt', `Parse error: ${e.message}`);
                console.error('Parse error:', e.message);
              }
            });
          });

          req.on('error', (e) => {
            fs.writeFileSync('review_output.txt', `Request error: ${e.message}`);
            console.error('Request error:', e.message);
          });

          req.write(requestBody);
          req.end();
          NODE_EOF

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review_output.txt', 'utf8');

            const body = `## ðŸ¤– AI Code Review

            ${review}

            ---
            *Automated review powered by Gemini AI*
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ¤– AI Code Review')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
